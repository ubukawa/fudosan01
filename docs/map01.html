<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<title>テスト地図 </title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://unpkg.com/maplibre-gl@4.1.3/dist/maplibre-gl.js'></script>
<link href='https://unpkg.com/maplibre-gl@4.1.3/dist/maplibre-gl.css' rel='stylesheet' />
<link href='https://www.unpkg.com/@watergis/maplibre-gl-export@3.4.1/dist/maplibre-gl-export.css' rel='stylesheet' />
<script src='https://www.unpkg.com/@watergis/maplibre-gl-export@3.4.1/dist/maplibre-gl-export.umd.js'></script>
<link href='https://ubukawa.github.io/cmv-test/watergis/maplibre-gl-legend@1.2.8/maplibre-gl-legend.css' rel='stylesheet' />
<script src='https://ubukawa.github.io/cmv-test/watergis/maplibre-gl-legend@1.2.8/maplibre-gl-legend.js'></script>
 
<style>
    body { margin:0; padding:0; }
    #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
    }
    p.cod1 { font-style:normal; font-size: 9pt; }
</style>
</head>
<body onload="popupFunction()">
    <style>
        .maplibregl-popup{
            max-width: 300px;
        }
        .map-overlay{
            font-style:bold;
            position: absolute;
            width: 25%;
            top: 0;
            left: 0;
            padding: 10px;
        }
        .map-overlay .map-overlay-inner {
            background-color: cornsilk;
            box-shadow: 0 1px 2px rgba(0,0,0, 0.2) ;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .map-overlay label{
            display: block;
            margin: 0 0 10px;
        }
        .map-overlay input {
            background-color: transparent;
            display: inline-block;
            width: 100%;
            position: relative;
            margin: 0;
            cursor: ew-resize;
        }
    </style>
 
<div id='map'></div>

<div class="map-overlay top">
    <div class="map-overlay-inner">
        <label>地図と写真の切替: <span id="slider-value">100%</span></label>
        <input id="slider" type="range" min="0" max="100" step="0" value="100">
    </div>
</div>

<script>
function popupFunction() {
   alert("Test")
}

var map = new maplibregl.Map({
  container: 'map', 
  attributionControl: false, //あとでaddControlの中で指定する
  hash: true, 
  //style: 'https://gsi-cyberjapan.github.io/optimal_bvmap/style/std.json', // スタイルファイルを外部ファイルで与える場合の例
  style: {
    version: 8,
    sprite: 'https://tile.openstreetmap.jp/styles/maptiler-toner-ja/sprite',
    sources: {
        photo: {
            type: 'raster',
            tiles: ['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'],
            attribution: '国土地理院-地理院タイル（写真）',
            maxzoom: 18,
            minzoom: 2
        },
        fudosan08: {
            type: 'vector',
            tiles: ['https://www.reinfolib.mlit.go.jp/ex-api/external/XPT001?response_format=pbf&z={z}&x={x}&y={y}&from=20183&to=20234'],
            attribution: '国土交通省-',
            maxzoom: 11,
            minzoom: 15
        }
    },
    layers:[
        {
            id: 'photo',
            type: 'raster',
            source: 'photo'
        }
    ]
  },
  center: [139.7444, 35.7244], // 中心の経度緯度
  zoom: 8, // 初期表示のズームレベル
  maxPitch: 85, //最大の傾き
  minZoom: 2, // 最小ズーム
  maxZoom: 18, // 最大ズーム
  /*
  transformRequest: function transformRequest(tiles, resourceType){
    return {tiles: tiles}

                if (resourceType == 'tiles' && tiles.includes('www.reinfolib.mlit.go.jp')) {
                    return {
                        tiles: tiles,
                        headers: { 'Ocp-Apim-Subscription-Key': '49d6d638592f4af896ebb4c30921d9ec' }
                    }
                } else {
                    return {
                        tiles: tiles,
                    }
                }

            }
    */

});

const slider = document.getElementById('slider')
const sliderValue = document.getElementById('slider-value')

map.on('load', function(){
    map.addSource('points',{
        type: 'geojson',
        data: {
            'type': 'FeatureCollection',
            'crs': {'type':'name','properties':{'name':'urn:ogc:def:crs:OGC:1.3:CRS84'}},
            'features': [
                {
                    'type':'Feature', 
                    'properties': {'p-type':'office','name':'職場','memo':'ABC町XYZ番地'},
                    'geometry':{'type':'Point','coordinates':[139.747386,35.671165]}
                },
                {
                    'type':'Feature', 
                    'properties': {'p-type':'home','name':'自宅A（ダミー）','memo':'DEF町GHI番地'},
                    'geometry':{'type':'Point','coordinates':[139.756809,35.673478]}}
            ]
        }
    })
    map.addSource('stdmap',{
        type: 'raster',
        tiles: ['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],
        attribution: '国土地理院-地理院タイル（標準地図）',
        maxzoom: 18,
        minzoom: 0
    })
    map.addSource('fudosan',{
        type: 'vector',
        tiles: ['https://www.reinfolib.mlit.go.jp/ex-api/external/XPT001?response_format=pbf&z={z}&x={x}&y={y}&from=20183&to=20234'],
        attribution: '国土交通省',
        transformRequest: (tiles) => {
            return{
                tiles: tiles,
                headers: { 'Ocp-Apim-Subscription-Key': '49d6d638592f4af896ebb4c30921d9ec' }
            }            
        },
        maxzoom: 14,
        minzoom: 12
    })


    map.addLayer({
        'id':'stdmap',
        'source':'stdmap',
        'type':'raster'
    })
    map.addLayer({
        'id':'locations',
        'type':'circle',
        'source':'points',
        'layout':{},
        'paint':{
            'circle-color': ['match',['get','p-type'],'office','#0000FF','home','#FF0000','#000000'],
            'circle-radius': 10
        }
    })
     map.addLayer({
        'id':'chika',
        'type':'symbol',
        'source':'fudosan',
        'source-layer': 'hits',
        'layout':{
            'icon-image': 'custom-marker',
            'icon-size': 0.5,
            'icon-allow-overlap': true,
            'icon-ignore-placement': true,
        }
    })
    slider.addEventListener('input',(e) => {
    map.setPaintProperty(
    'stdmap',
    'raster-opacity',
    parseInt(e.target.value, 10) / 100
    )
    sliderValue.textContent = e.target.value + '%';   
   })

    //凡例のプラグイン
    const legend_target = { 
        'locations':'職場(青)・自宅（赤）の位置'
    };

    map.addControl(new MaplibreLegendControl(legend_target, {
      showDefault: false,
      onlyRendered: false,
      reverseOrder: false
    }), 'bottom-left');
})

//pop-up
var popup = new maplibregl.Popup({
    closeButton: false,
    closeOnClick: false
})

map.on('mousemove','locations', function(e){
    map.getCanvas().style.cursor = 'pointer';

    if(e.features[0].properties.name){
        var html = "<p class='cod1'>" + e.features[0].properties.name + "<br />" + e.features[0].properties.memo + "</p>"
        popup
        .setLngLat(e.lngLat)
        .setHTML(html)
        .addTo(map)
    } else {
        popup.remove();
    }
})

map.on('mouseleave','locations', function(){
    map.getCanvas().style.cursor='';
    popup.remove();
})



//UI
map.addControl(new maplibregl.AttributionControl({customAttribution: "<br />MapLibre GL JSとwatergisのプラグインを使っています。" }));
map.addControl(new maplibregl.NavigationControl(), 'bottom-right');
map.addControl(new maplibregl.ScaleControl() );

//Export
map.addControl(new MaplibreExportControl({
  PageSize: Size.A4,
  PageOrientation: PageOrientation.Portrait,
  Format: Format.PNG,
  DPI: DPI[96],
  //Crosshair: true,
  PrintableArea: true,
  Local: 'en'
}), 'top-right');



//debug
map.showTileBoundaries = false;
map.showCollisionBoxes = false;

</script>
</body>
</html>
